<!doctype html>
<html>
  <head>
    <title>SSE Debug Test</title>
  </head>
  <body>
    <h1>SSE Debug Test</h1>
    <button id="testBtn">Test SSE Endpoint</button>
    <div
      id="output"
      style="white-space: pre-wrap; font-family: monospace; border: 1px solid #ccc; padding: 10px; margin-top: 10px"
    ></div>

    <script>
      const output = document.getElementById('output');

      function log(message) {
        output.textContent += message + '\n';
        console.log(message);
      }

      document.getElementById('testBtn').addEventListener('click', async () => {
        output.textContent = ''; // Clear output

        try {
          log('Sending POST request to SSE endpoint...');

          const response = await fetch('http://localhost:54587/api/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              messages: [{ role: 'user', content: 'Hello' }],
              model: 'llama3.2',
              stream: true,
            }),
          });

          log(`Response status: ${response.status}`);
          log(`Content-Type: ${response.headers.get('Content-Type')}`);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();

            if (done) {
              log('Stream complete');
              break;
            }

            buffer += decoder.decode(value, { stream: true });

            // Process complete events in the buffer
            const lines = buffer.split('\n');
            buffer = lines.pop() || ''; // Keep incomplete line in buffer

            for (const line of lines) {
              if (line.trim() === '') {
                continue;
              }

              log(`RAW LINE: ${line}`);

              if (line.startsWith('event:')) {
                log(`EVENT: ${line.substring(6).trim()}`);
              } else if (line.startsWith('data:')) {
                const data = line.substring(5).trim();
                log(`DATA: ${data}`);
                try {
                  const parsed = JSON.parse(data);
                  log(`PARSED: ${JSON.stringify(parsed, null, 2)}`);
                } catch (e) {
                  log(`PARSE ERROR: ${e.message}`);
                }
              }
            }
          }

          // Process any remaining data in buffer
          if (buffer.trim()) {
            log(`REMAINING BUFFER: ${buffer}`);
          }
        } catch (error) {
          log(`ERROR: ${error.message}`);
          console.error('Full error:', error);
        }
      });
    </script>
  </body>
</html>
